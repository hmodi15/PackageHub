<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LabelController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">one-to-one</a> &gt; <a href="index.source.html" class="el_package">onetomany.Labels</a> &gt; <span class="el_source">LabelController.java</span></div><h1>LabelController.java</h1><pre class="source lang-java linenums">package onetomany.Labels;

import io.swagger.v3.oas.annotations.Operation;
import onetomany.Labels.Label_Image;
import onetomany.Labels.LabelRepository;
import org.apache.commons.io.FileUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.MediaType;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import net.sourceforge.tess4j.Tesseract;
import net.sourceforge.tess4j.TesseractException;

import javax.imageio.ImageIO;
import javax.sql.rowset.serial.SerialBlob;
import javax.sql.rowset.serial.SerialException;
import java.awt.image.BufferedImage;
import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.sql.SQLException;
import java.util.ArrayList;

@RestController
<span class="fc" id="L26">public class LabelController {</span>


    // replace this! careful with the operating system in use
<span class="fc" id="L30">    private static String directory = &quot;../../../../../../../home/benjbart/imgfolder&quot;;//&quot;src/main/resources/imgfolder&quot;;//&quot;\\src\\main\\resources\\imgfolder&quot;;</span>

    @Autowired
    private LabelRepository labelRepository;


    @Operation(summary = &quot;Returns a byte array of the image&quot;)
    @GetMapping(value = &quot;/labels/{id}&quot;, produces = MediaType.IMAGE_JPEG_VALUE)
    byte[] getLabelById(@PathVariable int id) throws IOException {
<span class="nc" id="L39">        Label_Image image = labelRepository.findById(id);</span>
<span class="nc" id="L40">        File imageFile = new File(image.getFilePath());</span>
<span class="nc" id="L41">        return Files.readAllBytes(imageFile.toPath());</span>
    }

    @Operation(summary = &quot;Save the provided image as a Blob&quot;)
    @PostMapping(&quot;labels&quot;)
    public String handleFileUpload(@RequestParam(&quot;image&quot;) MultipartFile imageFile)  {
        try {
<span class="nc" id="L48">            File destinationFile = new File(directory + File.separator + imageFile.getOriginalFilename());</span>
<span class="nc" id="L49">            imageFile.transferTo(destinationFile);  // save file to disk</span>
<span class="nc" id="L50">            byte[] byteArray = FileUtils.readFileToByteArray(destinationFile);</span>
<span class="nc" id="L51">            Label_Image image = new Label_Image();</span>
<span class="nc" id="L52">            image.setFileName(imageFile.getOriginalFilename());</span>
<span class="nc" id="L53">            image.setFilePath(destinationFile.getAbsolutePath());</span>
<span class="nc" id="L54">            SerialBlob label_img = new SerialBlob(byteArray);</span>
<span class="nc" id="L55">            image.setImageBlob(label_img);</span>
<span class="nc" id="L56">            labelRepository.save(image);</span>
<span class="nc" id="L57">            return &quot;File uploaded successfully: &quot; + image.getId();//+ destinationFile.getAbsolutePath() + &quot;\n&quot;</span>
<span class="nc" id="L58">        } catch (IOException e) {</span>
<span class="nc" id="L59">            return &quot;Failed to upload file: &quot; + e.getMessage();</span>
<span class="nc" id="L60">        } catch (SQLException e) {</span>
<span class="nc" id="L61">            throw new RuntimeException(e);</span>
        }
    }


    @Operation(summary = &quot;Process an image stored in the Label Repository with Tesseract and return the string from Tesseract&quot;)
    @GetMapping(value = &quot;/labels/OCR/{id}&quot;)
    String processImageOCRById(@PathVariable int id) throws IOException {
<span class="nc" id="L69">        Label_Image image = labelRepository.findById(id);</span>
<span class="nc" id="L70">        File imageFile = new File(image.getFilePath());</span>
<span class="nc" id="L71">        Tesseract tesseract = new Tesseract();</span>
<span class="nc" id="L72">        ArrayList&lt;String&gt; labelByLine = new ArrayList&lt;&gt;();</span>

        try {
            char[] labelCharArray;
<span class="nc" id="L76">            String labelLine = &quot;&quot;;</span>
            //the path of your 'tessdata' folder
<span class="nc" id="L78">            tesseract.setDatapath(&quot;../../../../../../../usr/share/tesseract/tessdata&quot;);</span>


            //inside the extracted file
<span class="nc" id="L82">            String text = tesseract.doOCR(imageFile);</span>
<span class="nc" id="L83">            labelCharArray = text.toCharArray();</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">            for(char c : labelCharArray){</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">                if(c != '\n'){</span>
<span class="nc" id="L86">                    labelLine = labelLine + c;</span>
                }
                else{
<span class="nc" id="L89">                    labelByLine.add(labelLine);</span>
<span class="nc" id="L90">                    labelLine = &quot;&quot;;</span>
                }
            }

<span class="nc bnc" id="L94" title="All 2 branches missed.">            for(String line: labelByLine){</span>

<span class="nc" id="L96">            }</span>

            //path of the image file
            //System.out.print(text);
<span class="nc" id="L100">            return text;</span>
        }
<span class="nc" id="L102">        catch (TesseractException e) {</span>
<span class="nc" id="L103">            e.printStackTrace();</span>
        }
<span class="nc" id="L105">        return null;</span>
    }
/*
    @PostMapping(&quot;/labels/OCR&quot;)
    public String processPackageLabelOCR(@RequestParam(&quot;labels&quot;) MultipartFile imageFile)  {
        Tesseract tesseract = new Tesseract();
        tesseract.setDatapath(&quot;sftp://benjbart@coms-309-019.class.las.iastate.edu/home/benjbart/tess4j-5.10.0/tessdata&quot;);

        try {
            File destinationFile = new File(directory + File.separator + imageFile.getOriginalFilename());
            imageFile.transferTo(destinationFile);  // save file to disk

            Label_Image image = new Label_Image();
            image.setFilePath(destinationFile.getAbsolutePath());

            try {
                String ocrResult = tesseract.doOCR(destinationFile);
                //Some things to sort out the specific text from the result
                return ocrResult;
            } catch (TesseractException e) {
                e.printStackTrace();
            }

        } catch (IOException e) {
            return &quot;Failed to upload file: &quot; + e.getMessage();
        }
        return null;
    }*/


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>